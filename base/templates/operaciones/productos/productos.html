{% extends 'partials/admin/body.html' %}
{% load crispy_forms_tags %}
{% load bootstrap_icons %}

{% block contenido %}
  <div class="container-fluid m-4 row">
    <!-- Formulario -->
    <div class="rounded card p-3 col-md-3">
      <h5 class="card-title mb-3">{{ accion }} {{ titulo }}</h5>
      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form|crispy }}
        
        <input class="btn btn-success w-100 mb-2" type="submit" value="{{accion}} {{ titulo }}" />
        <a href="{% url 'productos' %}" class="btn btn-danger w-100">Cancelar</a>
      </form>

      <!-- Galería existente (solo en edición) -->
      {% if accion == "Editar" and imagenes_galeria %}
      <div class="mt-4">
        <h6 class="border-bottom pb-2">
          {% bs_icon 'images' %} Galería Actual ({{ imagenes_galeria.count }} imágenes)
        </h6>
        <div class="row g-2">
          {% for img in imagenes_galeria %}
          <div class="col-6">
            <div class="position-relative border rounded p-2">
              <img src="{{ img.imagen.url }}" alt="Imagen {{ img.orden }}" class="img-fluid rounded" style="width: 100%; height: 100px; object-fit: cover;">
              <div class="text-center mt-1">
                <small class="text-muted">Orden: {{ img.orden }}</small>
              </div>
              <form method="POST" action="{% url 'imagen_galeria_eliminar' img.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                        style="padding: 2px 6px; font-size: 12px;"
                        onclick="return confirm('¿Eliminar esta imagen?')">
                  {% bs_icon 'trash' %}
                </button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Tabla de productos -->
    <div class="rounded card p-3 mx-4 col-md-8">
      <table class="table table-bordered w-100 display nowrap" id="tabla-productos">
        <thead>
          <tr>
            <th>ID</th>
            <th>Imagen</th>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Tienda</th>
            <th>Galería</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          {% for producto in productos %}
            {% if producto.estado %}
            <tr>
              <td>{{ producto.id }}</td>
              <td>
                <img src="{{ producto.imagen.url }}" class="img-circle elevation-2" alt="{{ producto.nombre }}" width="60" />
              </td>
              <td>{{ producto.nombre }}</td>
              <td>${{ producto.precio|floatformat:0 }}</td>
              <td>{{ producto.tienda.nombre }}</td>
              <td class="text-center">
                <span class="badge bg-info">
                  {% bs_icon 'images' %} {{ producto.imagenes_galeria.count }}
                </span>
              </td>
              <td>
                <!-- Botón Eliminar con Modal -->
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#staticBackdrop{{producto.id}}">
                  {% bs_icon 'trash' %}
                </button>
                
                <!-- Modal de confirmación -->
                <div class="modal fade" id="staticBackdrop{{producto.id}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="staticBackdropLabel">¿Está seguro de eliminar el {{ titulo }}?</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <p>Está a punto de eliminar: <strong>{{ producto.nombre }}</strong></p>
                        <p class="text-danger">Una vez eliminado no hay marcha atrás</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <a href="{% url 'producto-eliminar' producto.id %}" class="btn btn-primary">¡Elimínalo!</a>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Botón Editar -->
                <a href="{% url 'producto-editar' producto.id %}" class="btn btn-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Editar">
                  {% bs_icon 'pencil' %}
                </a>
              </td>
            </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <style>
    /* Estilos para la galería en el sidebar */
    .galeria-item-img {
      transition: transform 0.2s;
    }
    .galeria-item-img:hover {
      transform: scale(1.05);
    }
  </style>
{% endblock %}