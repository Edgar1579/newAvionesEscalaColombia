{% extends 'partials/admin/body.html' %}
{% load crispy_forms_tags %}
{% load bootstrap_icons %}

{% block contenido %}
<div class="container-fluid m-4 row">

  <!-- ================= FORMULARIO ================= -->
  <div class="rounded card p-3 col-md-3">
    <h5 class="card-title mb-3">{{ accion }} {{ titulo }}</h5>

    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form|crispy }}

      <input class="btn btn-success w-100 mb-2" type="submit" value="{{ accion }} {{ titulo }}">
      <a href="{% url 'productos' %}" class="btn btn-danger w-100">Cancelar</a>
    </form>

    {% if accion == "Editar" and imagenes_galeria %}
    <div class="mt-4">
      <h6 class="border-bottom pb-2">
        {% bs_icon 'images' %} Galería Actual ({{ imagenes_galeria.count }})
      </h6>

      <div class="row g-2">
        {% for img in imagenes_galeria %}
        <div class="col-6">
          <div class="position-relative border rounded p-2">
            <img src="{{ img.imagen.url }}" class="img-fluid rounded"
                 style="width:100%; height:100px; object-fit:cover;">
            <small class="text-muted d-block text-center">Orden: {{ img.orden }}</small>

            <form method="POST" action="{% url 'imagen_galeria_eliminar' img.id %}">
              {% csrf_token %}
              <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1"
                      onclick="return confirm('¿Eliminar esta imagen?')">
                {% bs_icon 'trash' %}
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- ================= TABLA ================= -->
  <div class="rounded card p-3 mx-4 col-md-8">
    <table class="table table-bordered w-100 display nowrap" id="tabla-productos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Tienda</th>
          <th>Galería</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for producto in productos %}
          {% if producto.estado %}
          <tr>
            <td>{{ producto.id }}</td>
            <td>
              <img src="{{ producto.imagen.url }}" width="60"
                   class="img-circle elevation-2">
            </td>
            <td>{{ producto.nombre }}</td>
            <td>${{ producto.precio|floatformat:0 }}</td>
            <td>{{ producto.tienda.nombre }}</td>
            <td class="text-center">
              <span class="badge bg-info">
                {% bs_icon 'images' %} {{ producto.imagenes_galeria.count }}
              </span>
            </td>
            <td>
              <!-- BOTÓN ELIMINAR -->
              <button class="btn btn-danger btn-sm"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteModal"
                      data-id="{{ producto.id }}"
                      data-nombre="{{ producto.nombre }}">
                {% bs_icon 'trash' %}
              </button>

              <!-- BOTÓN EDITAR -->
              <a href="{% url 'producto-editar' producto.id %}"
                 class="btn btn-primary btn-sm">
                {% bs_icon 'pencil' %}
              </a>
            </td>
          </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ================= MODAL ÚNICO ================= -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">¿Eliminar {{ titulo }}?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="productoNombre"></p>
        <p class="text-danger fw-bold">
          Esta acción no se puede deshacer
        </p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="confirmDelete" class="btn btn-danger">Eliminar</a>
      </div>

    </div>
  </div>
</div>

<!-- ================= JS MODAL ================= -->
<script>
document.getElementById('deleteModal')
  .addEventListener('show.bs.modal', function (event) {

    const button = event.relatedTarget
    const id = button.getAttribute('data-id')
    const nombre = button.getAttribute('data-nombre')

    document.getElementById('productoNombre').innerHTML =
      `Está a punto de eliminar <strong>${nombre}</strong>`

    document.getElementById('confirmDelete').href =
      `{% url 'producto-eliminar' 0 %}`.replace('0', id)
})
</script>

{% endblock %}
